@page "/ui-generation"
@using GhostForge.Core.Models
@using GhostForge.Core.Services
@using Microsoft.Extensions.Logging
@inject UIService UIService
@inject ILogger<UIGeneration> Logger

<PageTitle>UI ç”Ÿæˆ - GhostForge</PageTitle>

<div class="mechanicus-container">
    <div class="mechanicus-header">
        <h1>âš™ GHOSTFORGE UI GENERATOR âš™</h1>
        <p class="subtitle">é€šè¿‡æœºå™¨ä¹‹çµå°†è‡ªç„¶è¯­è¨€è½¬åŒ–ä¸º XAML</p>
    </div>

    <div class="generation-panel">
        <div class="input-section">
            <label class="mechanicus-label">è¯·æè¿°æ‚¨éœ€è¦çš„ç•Œé¢ï¼š</label>
            <textarea @bind="userDescription" 
                      class="mechanicus-textarea" 
                      rows="5" 
                      placeholder="ä¾‹å¦‚ï¼šåˆ›å»ºä¸€ä¸ªæ•°æ®ç»Ÿè®¡é¢æ¿ï¼ŒåŒ…å«ä¸‰ä¸ªæŒ‡æ ‡å¡ç‰‡ï¼šCPUä½¿ç”¨ç‡ã€å†…å­˜å ç”¨ã€ç½‘ç»œæµé‡"></textarea>
            
            <button @onclick="GenerateXamlAsync" 
                    class="mechanicus-button" 
                    disabled="@isGenerating">
                @if (isGenerating)
                {
                    <span>âš™ é”»é€ ä¸­...</span>
                }
                else
                {
                    <span>âš™ ç”Ÿæˆ XAML âš™</span>
                }
            </button>
        </div>

        @if (!string.IsNullOrEmpty(generatedXaml))
        {
            <div class="result-section">
                <div class="result-header">
                    <h3>ç”Ÿæˆç»“æœ</h3>
                    @if (isValid)
                    {
                        <span class="status-success">âœ“ éªŒè¯é€šè¿‡</span>
                    }
                    else
                    {
                        <span class="status-error">âœ— éªŒè¯å¤±è´¥</span>
                    }
                </div>

                @if (!string.IsNullOrEmpty(validationError))
                {
                    <div class="alert-error">
                        <strong>é”™è¯¯:</strong> @validationError
                    </div>
                }

                <div class="code-container">
                    <pre><code>@generatedXaml</code></pre>
                </div>

                <div class="action-buttons">
                    <button @onclick="CopyToClipboard" class="mechanicus-button-secondary">
                        ğŸ“‹ å¤åˆ¶ä»£ç 
                    </button>
                    <button @onclick="ClearResult" class="mechanicus-button-secondary">
                        ğŸ—‘ æ¸…é™¤ç»“æœ
                    </button>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(statusMessage))
        {
            <div class="status-message">
                @statusMessage
            </div>
        }
    </div>
</div>

@code {
    private string userDescription = "";
    private string generatedXaml = "";
    private bool isGenerating = false;
    private bool isValid = false;
    private string? validationError = null;
    private string statusMessage = "";

    private async Task GenerateXamlAsync()
    {
        Logger.LogInformation("ğŸš€ [UI] ç”¨æˆ·ç‚¹å‡»äº†ç”ŸæˆæŒ‰é’®");
        
        if (string.IsNullOrWhiteSpace(userDescription))
        {
            statusMessage = "è¯·è¾“å…¥ç•Œé¢æè¿°";
            Logger.LogWarning("âš ï¸ [UI] ç”¨æˆ·è¾“å…¥ä¸ºç©º");
            return;
        }

        Logger.LogInformation("ğŸ“ [UI] ç”¨æˆ·æè¿°: {Description}", userDescription);
        
        isGenerating = true;
        statusMessage = "æ­£åœ¨è°ƒç”¨æœºå™¨ä¹‹çµ...";
        generatedXaml = "";
        validationError = null;

        try
        {
            Logger.LogInformation("ğŸ”„ [UI] å¼€å§‹è°ƒç”¨ UIService.GenerateXamlAsync...");
            var result = await UIService.GenerateXamlAsync(userDescription);
            Logger.LogInformation("âœ… [UI] UIService è°ƒç”¨å®Œæˆ");
            
            generatedXaml = result.XamlCode;
            isValid = result.IsValid;
            validationError = result.ValidationError;
            
            Logger.LogInformation("ğŸ“Š [UI] ç”Ÿæˆç»“æœ - æœ‰æ•ˆ: {IsValid}, XAMLé•¿åº¦: {Length}", isValid, generatedXaml?.Length ?? 0);
            
            if (isValid)
            {
                statusMessage = "âœ“ XAML ç”ŸæˆæˆåŠŸï¼";
                Logger.LogInformation("ğŸ‰ [UI] XAML éªŒè¯é€šè¿‡");
            }
            else
            {
                statusMessage = "âš  XAML å·²ç”Ÿæˆä½†éªŒè¯å¤±è´¥";
                Logger.LogWarning("âš ï¸ [UI] XAML éªŒè¯å¤±è´¥: {Error}", validationError);
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"ç”Ÿæˆå¤±è´¥: {ex.Message}";
            Logger.LogError(ex, "âŒ [UI] ç”Ÿæˆè¿‡ç¨‹å‡ºç°å¼‚å¸¸");
            isValid = false;
        }
        finally
        {
            isGenerating = false;
            Logger.LogInformation("ğŸ [UI] ç”Ÿæˆæµç¨‹ç»“æŸ");
        }
    }

    private async Task CopyToClipboard()
    {
        // Note: Clipboard API requires JavaScript interop in Blazor
        statusMessage = "ä»£ç å·²å¤åˆ¶ï¼ˆéœ€è¦å®ç° JS Interopï¼‰";
    }

    private void ClearResult()
    {
        generatedXaml = "";
        validationError = null;
        statusMessage = "";
        isValid = false;
    }
}
