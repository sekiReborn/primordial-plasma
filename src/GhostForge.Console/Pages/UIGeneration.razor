@page "/ui-generation"
@using GhostForge.Core.Models
@using GhostForge.Core.Services
@using Microsoft.Extensions.Logging
@inject UIService UIService
@inject ILogger<UIGeneration> Logger
@inject IJSRuntime JSRuntime

<PageTitle>UI ç”Ÿæˆ - GhostForge</PageTitle>

<div class="mechanicus-container">
    <div class="mechanicus-header">
        <h1>âš™ GHOSTFORGE UI GENERATOR âš™</h1>
        <p class="subtitle">é€šè¿‡æœºå™¨ä¹‹çµå°†è‡ªç„¶è¯­è¨€è½¬åŒ–ä¸º XAML</p>
    </div>

    <!-- é€šçŸ¥ç³»ç»Ÿ -->
    @if (notifications.Any())
    {
        <div class="notification-container">
            @foreach (var notification in notifications)
            {
                <div class="notification notification-@notification.Type.ToString().ToLower()" @key="notification.Id">
                    <div class="notification-content">
                        <span class="notification-icon">@GetNotificationIcon(notification.Type)</span>
                        <span class="notification-message">@notification.Message</span>
                    </div>
                    <button class="notification-close" @onclick="() => DismissNotification(notification.Id)">Ã—</button>
                </div>
            }
        </div>
    }

    <div class="generation-panel">
        <!-- æ¨¡å‹é€‰æ‹©å’Œé…ç½® -->
        <div class="model-selector-section">
            <label class="mechanicus-label" for="model-select">ğŸ¤– é€‰æ‹©æ¨¡å‹ï¼š</label>
            <select id="model-select" 
                    class="model-dropdown" 
                    @bind="selectedModel"
                    @bind:after="OnModelSelectionChanged">
                <option value="deepseek-r1">ğŸ§  DeepSeek-R1 - æ¨ç†æ¨¡å‹ (é€»è¾‘æ€§å¼º)</option>
                <option value="Qwen2.5-72B">ğŸ”® Qwen2.5-72B - é€šç”¨æ¨¡å‹ (åˆ›æ„æ€§å¼º)</option>
                <option value="gemini-2.0-flash">âœ¨ Gemini 2.0 Flash - Google AI (å¿«é€Ÿé«˜æ•ˆ)</option>
            </select>
            <div class="model-info">
                @GetModelDescription(selectedModel)
            </div>
        </div>

        <!-- é¢„è®¾æç¤ºè¯ -->
        <div class="prompts-section">
            <label class="mechanicus-label">ğŸ’¡ å¿«é€Ÿå¼€å§‹ - é€‰æ‹©æ¨¡æ¿ï¼š</label>
            <div class="prompt-templates">
                @foreach (var template in promptTemplates)
                {
                    <button class="prompt-template-btn" @onclick="() => UseTemplate(template.Prompt)">
                        <span class="template-icon">@template.Icon</span>
                        <span class="template-name">@template.Name</span>
                    </button>
                }
            </div>
        </div>

        <!-- ç”¨æˆ·è¾“å…¥ -->
        <div class="input-section">
            <label class="mechanicus-label">ğŸ“ æè¿°æ‚¨éœ€è¦çš„ç•Œé¢ï¼š</label>
            <textarea @bind="userDescription" 
                      class="mechanicus-textarea" 
                      rows="6" 
                      placeholder="ä¾‹å¦‚ï¼šåˆ›å»ºä¸€ä¸ªæ•°æ®ç»Ÿè®¡é¢æ¿ï¼ŒåŒ…å«ä¸‰ä¸ªæŒ‡æ ‡å¡ç‰‡ï¼šCPUä½¿ç”¨ç‡ã€å†…å­˜å ç”¨ã€ç½‘ç»œæµé‡"></textarea>
            
            <div class="action-row">
                <button @onclick="GenerateXamlAsync" 
                        class="mechanicus-button" 
                        disabled="@isGenerating">
                    @if (isGenerating)
                    {
                        <span class="loading-spinner">âš™</span>
                        <span>é”»é€ ä¸­...</span>
                    }
                    else
                    {
                        <span>âš™ ç”Ÿæˆ XAML âš™</span>
                    }
                </button>
                @if (!string.IsNullOrEmpty(userDescription))
                {
                    <button @onclick="ClearInput" class="mechanicus-button-secondary">
                        ğŸ—‘ æ¸…ç©ºè¾“å…¥
                    </button>
                }
            </div>
        </div>

        <!-- ç”Ÿæˆç»“æœ -->
        @if (!string.IsNullOrEmpty(generatedXaml))
        {
            <div class="result-section">
                <div class="result-header">
                    <h3>âš¡ ç”Ÿæˆç»“æœ</h3>
                    <div class="result-status">
                        @if (isValid)
                        {
                            <span class="status-success">âœ“ éªŒè¯é€šè¿‡</span>
                        }
                        else
                        {
                            <span class="status-error">âœ— éªŒè¯å¤±è´¥</span>
                        }
                        <span class="code-stats">@generatedXaml.Length å­—ç¬¦</span>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(validationError))
                {
                    <div class="alert-error">
                        <strong>âš  é”™è¯¯:</strong> @validationError
                    </div>
                }

                <div class="code-container">
                    <pre><code>@generatedXaml</code></pre>
                </div>

                <div class="action-buttons">
                    <button @onclick="CopyToClipboard" class="mechanicus-button-secondary">
                        ğŸ“‹ å¤åˆ¶ä»£ç 
                    </button>
                    <button @onclick="DownloadXaml" class="mechanicus-button-secondary">
                        ğŸ’¾ ä¸‹è½½ XAML
                    </button>
                    <button @onclick="ClearResult" class="mechanicus-button-secondary">
                        ğŸ—‘ æ¸…é™¤ç»“æœ
                    </button>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private string userDescription = "";
    private string generatedXaml = "";
    private bool isGenerating = false;
    private bool isValid = false;
    private string? validationError = null;
    private string selectedModel = "deepseek-r1";
    
    // é€šçŸ¥ç³»ç»Ÿ
    private List<Notification> notifications = new();
    private int notificationIdCounter = 0;

    // é¢„è®¾æç¤ºè¯æ¨¡æ¿
    private List<PromptTemplate> promptTemplates = new()
    {
        new PromptTemplate { Icon = "ğŸ“", Name = "ç™»å½•è¡¨å•", Prompt = "åˆ›å»ºä¸€ä¸ªç™»å½•è¡¨å•ï¼ŒåŒ…å«ç”¨æˆ·åè¾“å…¥æ¡†ã€å¯†ç è¾“å…¥æ¡†ã€è®°ä½æˆ‘å¤é€‰æ¡†å’Œç™»å½•æŒ‰é’®" },
        new PromptTemplate { Icon = "ğŸ“Š", Name = "æ•°æ®é¢æ¿", Prompt = "åˆ›å»ºä¸€ä¸ªæ•°æ®ç»Ÿè®¡é¢æ¿ï¼ŒåŒ…å«ä¸‰ä¸ªæŒ‡æ ‡å¡ç‰‡ï¼šCPUä½¿ç”¨ç‡ã€å†…å­˜å ç”¨ã€ç½‘ç»œæµé‡ï¼Œæ¯ä¸ªå¡ç‰‡æ˜¾ç¤ºæ ‡é¢˜ã€æ•°å€¼å’Œè¿›åº¦æ¡" },
        new PromptTemplate { Icon = "âš™", Name = "è®¾ç½®é¡µé¢", Prompt = "åˆ›å»ºä¸€ä¸ªè®¾ç½®ç•Œé¢ï¼ŒåŒ…å«ä¸»é¢˜é€‰æ‹©ã€è¯­è¨€é€‰æ‹©ã€é€šçŸ¥å¼€å…³å’Œä¿å­˜æŒ‰é’®" },
        new PromptTemplate { Icon = "ğŸ‘¤", Name = "ç”¨æˆ·èµ„æ–™", Prompt = "åˆ›å»ºä¸€ä¸ªç”¨æˆ·èµ„æ–™ç¼–è¾‘ç•Œé¢ï¼ŒåŒ…å«å¤´åƒã€å§“åã€é‚®ç®±ã€ç”µè¯ã€ä¸ªäººç®€ä»‹è¾“å…¥æ¡†å’Œä¿å­˜æŒ‰é’®" },
        new PromptTemplate { Icon = "ğŸ“", Name = "æ–‡ä»¶åˆ—è¡¨", Prompt = "åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æµè§ˆå™¨ç•Œé¢ï¼ŒåŒ…å«æ–‡ä»¶åˆ—è¡¨ã€æœç´¢æ¡†ã€æ’åºé€‰é¡¹å’Œæ“ä½œæŒ‰é’®" },
        new PromptTemplate { Icon = "ğŸ’¬", Name = "èŠå¤©ç•Œé¢", Prompt = "åˆ›å»ºä¸€ä¸ªèŠå¤©ç•Œé¢ï¼ŒåŒ…å«æ¶ˆæ¯åˆ—è¡¨ã€è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’®ï¼Œä½¿ç”¨æœºæ¢°æ•™é£æ ¼" }
    };

    protected override void OnInitialized()
    {
        ShowNotification("æ¬¢è¿ä½¿ç”¨ GhostForge UI ç”Ÿæˆå™¨", NotificationType.Info);
    }

    private void OnModelSelectionChanged()
    {
        ShowNotification($"å·²åˆ‡æ¢åˆ°æ¨¡å‹: {GetModelDisplayName(selectedModel)}", NotificationType.Info);
    }

    private string GetModelDisplayName(string model) => model switch
    {
        "deepseek-r1" => "DeepSeek-R1",
        "Qwen2.5-72B" => "Qwen2.5-72B",
        "gemini-2.0-flash" => "Gemini 2.0 Flash",
        _ => model
    };

    private string GetModelDescription(string model) => model switch
    {
        "deepseek-r1" => "DeepSeek-R1 ä¸“æ³¨äºæ¨ç†ä»»åŠ¡ï¼Œé€‚åˆç”Ÿæˆé€»è¾‘å¤æ‚çš„ç•Œé¢ç»“æ„",
        "Qwen2.5-72B" => "Qwen2.5-72B æ˜¯é€šç”¨æ¨¡å‹ï¼Œæ“…é•¿åˆ›æ„è®¾è®¡å’Œçµæ´»å¸ƒå±€",
        "gemini-2.0-flash" => "Gemini 2.0 Flash æ˜¯ Google æœ€æ–°çš„è½»é‡çº§æ¨¡å‹ï¼Œå¿«é€Ÿä¸”é«˜æ•ˆ",
        _ => "è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹"
    };

    private void UseTemplate(string prompt)
    {
        userDescription = prompt;
        ShowNotification("å·²åº”ç”¨æ¨¡æ¿", NotificationType.Success);
    }

    private async Task GenerateXamlAsync()
    {
        Logger.LogInformation("ğŸš€ [UI] ç”¨æˆ·ç‚¹å‡»äº†ç”ŸæˆæŒ‰é’®");
        
        if (string.IsNullOrWhiteSpace(userDescription))
        {
            ShowNotification("è¯·è¾“å…¥ç•Œé¢æè¿°æˆ–é€‰æ‹©æ¨¡æ¿", NotificationType.Warning);
            Logger.LogWarning("âš ï¸ [UI] ç”¨æˆ·è¾“å…¥ä¸ºç©º");
            return;
        }

        Logger.LogInformation("ğŸ“ [UI] ç”¨æˆ·æè¿°: {Description}", userDescription);
        Logger.LogInformation("ğŸ¤– [UI] ä½¿ç”¨æ¨¡å‹: {Model}", selectedModel);
        
        isGenerating = true;
        generatedXaml = "";
        validationError = null;
        ShowNotification("æ­£åœ¨è°ƒç”¨æœºå™¨ä¹‹çµ...", NotificationType.Info);

        try
        {
            // TODO: æ ¹æ®é€‰æ‹©çš„æ¨¡å‹è°ƒç”¨ä¸åŒçš„æœåŠ¡
            // ç›®å‰ä½¿ç”¨é»˜è®¤çš„ UIService
            Logger.LogInformation("ğŸ”„ [UI] å¼€å§‹è°ƒç”¨ UIService.GenerateXamlAsync...");
            var result = await UIService.GenerateXamlAsync(userDescription);
            Logger.LogInformation("âœ… [UI] UIService è°ƒç”¨å®Œæˆ");
            
            generatedXaml = result.XamlCode;
            isValid = result.IsValid;
            validationError = result.ValidationError;
            
            Logger.LogInformation("ğŸ“Š [UI] ç”Ÿæˆç»“æœ - æœ‰æ•ˆ: {IsValid}, XAMLé•¿åº¦: {Length}", isValid, generatedXaml?.Length ?? 0);
            
            if (isValid)
            {
                ShowNotification($"âœ“ XAML ç”ŸæˆæˆåŠŸï¼({generatedXaml.Length} å­—ç¬¦)", NotificationType.Success);
                Logger.LogInformation("ğŸ‰ [UI] XAML éªŒè¯é€šè¿‡");
            }
            else
            {
                ShowNotification("âš  XAML å·²ç”Ÿæˆä½†éªŒè¯å¤±è´¥", NotificationType.Warning);
                Logger.LogWarning("âš ï¸ [UI] XAML éªŒè¯å¤±è´¥: {Error}", validationError);
            }
        }
        catch (Exception ex)
        {
            ShowNotification($"ç”Ÿæˆå¤±è´¥: {ex.Message}", NotificationType.Error);
            Logger.LogError(ex, "âŒ [UI] ç”Ÿæˆè¿‡ç¨‹å‡ºç°å¼‚å¸¸");
            isValid = false;
        }
        finally
        {
            isGenerating = false;
            Logger.LogInformation("ğŸ [UI] ç”Ÿæˆæµç¨‹ç»“æŸ");
        }
    }

    private async Task CopyToClipboard()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", generatedXaml);
            ShowNotification("âœ“ ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", NotificationType.Success);
        }
        catch
        {
            ShowNotification("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶", NotificationType.Warning);
        }
    }

    private async Task DownloadXaml()
    {
        try
        {
            var fileName = $"GhostForge_{DateTime.Now:yyyyMMdd_HHmmss}.xaml";
            var bytes = System.Text.Encoding.UTF8.GetBytes(generatedXaml);
            var base64 = Convert.ToBase64String(bytes);
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64);
            ShowNotification($"âœ“ å·²ä¸‹è½½: {fileName}", NotificationType.Success);
        }
        catch
        {
            ShowNotification("ä¸‹è½½å¤±è´¥", NotificationType.Error);
        }
    }

    private void ClearInput()
    {
        userDescription = "";
        ShowNotification("å·²æ¸…ç©ºè¾“å…¥", NotificationType.Info);
    }

    private void ClearResult()
    {
        generatedXaml = "";
        validationError = null;
        isValid = false;
        ShowNotification("å·²æ¸…é™¤ç»“æœ", NotificationType.Info);
    }

    // é€šçŸ¥ç³»ç»Ÿæ–¹æ³•
    private void ShowNotification(string message, NotificationType type, int durationMs = 5000)
    {
        var notification = new Notification
        {
            Id = ++notificationIdCounter,
            Message = message,
            Type = type,
            Timestamp = DateTime.Now
        };

        notifications.Add(notification);
        StateHasChanged();

        // è‡ªåŠ¨å…³é—­
        _ = Task.Run(async () =>
        {
            await Task.Delay(durationMs);
            DismissNotification(notification.Id);
        });
    }

    private void DismissNotification(int id)
    {
        notifications.RemoveAll(n => n.Id == id);
        InvokeAsync(StateHasChanged);
    }

    private string GetNotificationIcon(NotificationType type) => type switch
    {
        NotificationType.Success => "âœ“",
        NotificationType.Error => "âœ—",
        NotificationType.Warning => "âš ",
        NotificationType.Info => "â„¹",
        _ => "â€¢"
    };

    // æ•°æ®æ¨¡å‹
    private class PromptTemplate
    {
        public string Icon { get; set; } = "";
        public string Name { get; set; } = "";
        public string Prompt { get; set; } = "";
    }

    private class Notification
    {
        public int Id { get; set; }
        public string Message { get; set; } = "";
        public NotificationType Type { get; set; }
        public DateTime Timestamp { get; set; }
    }

    private enum NotificationType
    {
        Success,
        Error,
        Warning,
        Info
    }
}
